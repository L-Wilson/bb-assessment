name: Backend App CI

on:
  workflow_call:
    inputs:
      push-image:
        description: Push the built image to ECR.
        required: false
        type: boolean
        default: false
      environment:
        description: Target environment for repository naming.
        required: false
        type: string
        default: development
    outputs:
      image_tag:
        description: Built image tag.
        value: ${{ jobs.backend-ci.outputs.image_tag }}
      image_uri:
        description: Full ECR image URI.
        value: ${{ jobs.backend-ci.outputs.image_uri }}

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: eu-central-1

jobs:
  backend-ci:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      image_uri: ${{ steps.meta.outputs.image_uri }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: url-shortener/backend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: url-shortener/backend

      - name: Lint / type check
        run: npm run lint
        working-directory: url-shortener/backend

      - name: Unit tests
        run: npm test -- --ci
        working-directory: url-shortener/backend

      - name: Dependency security audit
        run: npm audit --audit-level=high
        working-directory: url-shortener/backend

      - name: Compute image metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_TAG="${GITHUB_SHA::12}"
          REPOSITORY="bb-assessment-urlshortener-${{ inputs.environment }}-api"
          IMAGE_URI="${REPOSITORY}:${IMAGE_TAG}"
          echo "image_tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "image_uri=${IMAGE_URI}" >> "$GITHUB_OUTPUT"

      - name: Build container image
        run: docker build -t "${{ steps.meta.outputs.image_uri }}" .
        working-directory: url-shortener/backend

      - name: Container security scan
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: ${{ steps.meta.outputs.image_uri }}
          format: table
          exit-code: '1'
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: Configure AWS credentials (OIDC)
        if: ${{ inputs.push-image }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ vars.AWS_GITHUB_ROLE }}
          role-session-name: gha-backend-ci-${{ github.run_id }}-${{ github.run_attempt }}

      - name: Login to Amazon ECR
        if: ${{ inputs.push-image }}
        id: login_ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Push image
        if: ${{ inputs.push-image }}
        shell: bash
        run: |
          set -euo pipefail
          ECR_IMAGE="${{ steps.login_ecr.outputs.registry }}/bb-assessment-urlshortener-${{ inputs.environment }}-api:${{ steps.meta.outputs.image_tag }}"
          docker tag "${{ steps.meta.outputs.image_uri }}" "${ECR_IMAGE}"
          docker push "${ECR_IMAGE}"
